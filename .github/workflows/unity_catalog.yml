# ============================================================================
# Unity Catalog Governance - Declarative RBAC Configuration
# Catalog: mco_catalog | Namespace: catalog.schema.table
# ============================================================================

name: Unity Catalog Governance

on:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/unity_catalog.yml'
      - 'infra/**'
  workflow_dispatch:

jobs:
  apply-governance:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Databricks CLI
        run: |
          pip install databricks-cli
      
      - name: Configure Databricks
        run: |
          databricks configure --token <<EOF
          ${{ secrets.DATABRICKS_HOST }}
          ${{ secrets.DATABRICKS_TOKEN }}
          EOF
      
      - name: Create Catalog
        run: |
          databricks unity-catalog catalogs create \
            --name mco_catalog \
            --comment "MCO (Mobilidade e Cidadania Operacional) - Arquitetura Medalhão com governança RBAC" \
            --properties '{"lineage_enabled":"true","data_classification":"public","owner":"engineers_group"}' \
            || echo "Catalog already exists"
      
      # --------------------------------------------------------------------
      # Bronze Schema - Raw Data Layer
      # --------------------------------------------------------------------
      
      - name: Create Bronze Schema
        run: |
          databricks unity-catalog schemas create \
            --catalog-name mco_catalog \
            --name bronze \
            --comment "Camada Bronze: Dados brutos e imutáveis com metadados de ingestão (_ingestion_timestamp, _source_url)" \
            --properties '{"layer":"bronze","data_type":"raw","is_immutable":"true","lineage_enabled":"true"}' \
            || echo "Bronze schema already exists"
      
      - name: Grant Bronze Permissions - Engineers
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.bronze \
            --principal engineers_group \
            --privileges ALL_PRIVILEGES
      
      - name: Grant Bronze Permissions - Compliance Auditors
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.bronze \
            --principal compliance_auditors_group \
            --privileges SELECT,USE_SCHEMA
      
      # --------------------------------------------------------------------
      # Silver Schema - Validated Data Layer
      # --------------------------------------------------------------------
      
      - name: Create Silver Schema
        run: |
          databricks unity-catalog schemas create \
            --catalog-name mco_catalog \
            --name silver \
            --comment "Camada Silver: Dados limpos, validados e desduplicados (single source of truth)" \
            --properties '{"layer":"silver","data_type":"validated","operations":"cleaning,deduplication,normalization","lineage_enabled":"true"}' \
            || echo "Silver schema already exists"
      
      - name: Grant Silver Permissions - Engineers
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.silver \
            --principal engineers_group \
            --privileges ALL_PRIVILEGES
      
      - name: Grant Silver Permissions - Data Scientists
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.silver \
            --principal data_scientists_group \
            --privileges SELECT,USE_SCHEMA
      
      # --------------------------------------------------------------------
      # Gold Schema - Business Aggregates Layer
      # --------------------------------------------------------------------
      
      - name: Create Gold Schema
        run: |
          databricks unity-catalog schemas create \
            --catalog-name mco_catalog \
            --name gold \
            --comment "Camada Gold: Agregados de negócio e modelagem Star Schema (dim_linha, dim_data, fact_passageiros)" \
            --properties '{"layer":"gold","data_type":"aggregated","modeling":"star_schema","optimization":"zorder,partitioning","lineage_enabled":"true"}' \
            || echo "Gold schema already exists"
      
      - name: Grant Gold Permissions - Engineers
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.gold \
            --principal engineers_group \
            --privileges ALL_PRIVILEGES
      
      - name: Grant Gold Permissions - Analysts
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.gold \
            --principal analysts_group \
            --privileges SELECT,USE_SCHEMA
      
      - name: Grant Gold Permissions - Business Executives
        run: |
          databricks unity-catalog grants update \
            --securable-type SCHEMA \
            --full-name mco_catalog.gold \
            --principal business_executives_group \
            --privileges SELECT
      
      # --------------------------------------------------------------------
      # Enable Lineage Tracking
      # --------------------------------------------------------------------
      
      - name: Enable Automatic Lineage
        run: |
          databricks unity-catalog catalogs update \
            --name mco_catalog \
            --properties '{"delta.enableChangeDataFeed":"true","lineage.enabled":"true"}'
      
      - name: Governance Summary
        run: |
          echo "✅ Unity Catalog Governance Applied"
          echo "Catalog: mco_catalog"
          echo "Schemas: bronze, silver, gold"
          echo "RBAC Groups: engineers_group, compliance_auditors_group, data_scientists_group, analysts_group, business_executives_group"
          echo "Lineage: Enabled"
